// import './style.css'
// import javascriptLogo from './javascript.svg'
// import viteLogo from '/vite.svg'
// import { setupCounter } from './counter.js'
//
// document.querySelector('#app').innerHTML = `
//   <div>
//     <a href="https://vite.dev" target="_blank">
//       <img assets="${viteLogo}" class="logo" alt="Vite logo" />
//     </a>
//     <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript" target="_blank">
//       <img assets="${javascriptLogo}" class="logo vanilla" alt="JavaScript logo" />
//     </a>
//     <h1>Hello Vite!</h1>
//     <div class="card">
//       <button id="counter" type="button"></button>
//     </div>
//     <p class="read-the-docs">
//       Click on the Vite logo to learn more
//     </p>
//   </div>
// `
//
// setupCounter(document.querySelector('#counter'))
import { db } from "./firebase.js";
import { collection, addDoc, query, where, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// ÿØÿßŸÑÿ© ŸÑÿ™ŸàŸÑŸäÿØ 4 ÿ£ÿ±ŸÇÿßŸÖ ÿπÿ¥Ÿàÿßÿ¶Ÿäÿ©
function generateCode() {
    return Math.floor(1000 + Math.random() * 9000).toString();
}

document.addEventListener("DOMContentLoaded", () => {
    const emailInput = document.querySelector("input[type='email']");
    const countrySelect = document.getElementById("country");
    const codeSelect = document.getElementById("code");
    const phoneInput = document.querySelector("input[type='number']");
    const nextBtn = document.querySelector("button");

    const countryCodes = {
        ye: "+967",
        sa: "+966",
        eg: "+20",
        us: "+1",
        uk: "+44"
    };

    countrySelect.addEventListener("change", () => {
        const country = countrySelect.value;
        codeSelect.innerHTML = "";
        if (country && countryCodes[country]) {
            const option = document.createElement("option");
            option.value = countryCodes[country];
            option.textContent = countryCodes[country];
            codeSelect.appendChild(option);
        }
    });

    nextBtn.addEventListener("click", async () => {
        const email = emailInput.value.trim();
        const country = countrySelect.value;
        const code = codeSelect.value;
        const phone = phoneInput.value.trim();

        if (!email || !country || !code || !phone) {
            alert("ŸÖŸÜ ŸÅÿ∂ŸÑŸÉ ÿ£ÿØÿÆŸÑ ŸÉŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™");
            return;
        }

        const msgDiv = document.getElementById("message");
        const overlay = document.getElementById("overlay");
        const login = document.getElementById("login");
        const verifying = document.getElementById("verifying");

        overlay.classList.remove("hidden");
        msgDiv.classList.remove("opacity-0");
        msgDiv.classList.add("opacity-100");

        try {
            const verificationCode = generateCode();

            await addDoc(collection(db, "users"), {
                email,
                country,
                code,
                phone,
                verificationCode,
                isVerified: false,
                createdAt: new Date()
            });

            sendVerificationEmail(email, verificationCode);

        } catch (e) {
            console.error("‚ùå ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ≠ŸÅÿ∏:", e);
            alert("ÿ≠ÿµŸÑ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ≠ŸÅÿ∏ üò¢");
        } finally {
            // üîπ ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿÆŸÑŸÅŸäÿ© + ÿßŸÑÿ£ŸäŸÇŸàŸÜÿ©
            msgDiv.classList.remove("opacity-100");
            msgDiv.classList.add("opacity-0");
            overlay.classList.add("hidden");

            login.classList.add("hidden");

            verifying.classList.remove("hidden", "opacity-0");
            verifying.classList.add("opacity-100", "transition-opacity", "duration-500");

            function maskEmail(email) {
                const [name, domain] = email.split("@");
                const maskedName = name.slice(0, 2) + "******";
                return maskedName + "@" + domain;
            }

            document.getElementById("messageemail").textContent =
                maskEmail(email) + " ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ŸÖÿ≤ ÿ•ŸÑŸâ ";
        }
    });

    function sendVerificationEmail(email, code) {
        emailjs.send("service_003idgu", "template_wgap7m6", {
            to_email: email,
            message: `ÿ±ŸÖÿ≤ ÿßŸÑÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ ŸáŸà: ${code}`
        }).then(() => {
            console.log("üì© ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ•ŸäŸÖŸäŸÑ ÿ®ŸÜÿ¨ÿßÿ≠");
        }).catch((err) => {
            console.error("ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ•ŸäŸÖŸäŸÑ:", err);
        });
    }

    document.getElementById("back-to-login").addEventListener("click", () => {
        const login = document.getElementById("login");
        const verifying = document.getElementById("verifying");

        verifying.classList.add("hidden");

        login.classList.remove("hidden");

    });

    document.getElementById("otp-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        // üü¢ ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
        document.getElementById("overlay").classList.remove("hidden");
        const msgDiv = document.getElementById("message");
        msgDiv.classList.remove("opacity-0");
        msgDiv.classList.add("opacity-100");

        const otpInputs = document.querySelectorAll(".otp-input");
        let enteredCode = "";
        otpInputs.forEach(input => enteredCode += input.value.trim());

        const email = emailInput.value.trim();  // ‚Üê ŸÖÿ™ÿ∫Ÿäÿ±ŸÉ ÿßŸÑÿ£ÿµŸÑŸä

        if (enteredCode.length < 4) {
            // ‚ùå ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿπŸÜÿØ ÿßŸÑÿÆÿ∑ÿ£
            document.getElementById("overlay").classList.add("hidden");
            msgDiv.classList.remove("opacity-100");
            msgDiv.classList.add("opacity-0");

            alert("ŸÖŸÜ ŸÅÿ∂ŸÑŸÉ ÿ£ÿØÿÆŸÑ ÿ¨ŸÖŸäÿπ ÿ£ÿ±ŸÇÿßŸÖ OTP");
            return;
        }

        try {
            const q = query(collection(db, "users"), where("email", "==", email));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                // ‚ùå ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿπŸÜÿØ ÿßŸÑÿÆÿ∑ÿ£
                document.getElementById("overlay").classList.add("hidden");
                msgDiv.classList.remove("opacity-100");
                msgDiv.classList.add("opacity-0");

                alert("‚ùå ÿßŸÑÿ®ÿ±ŸäÿØ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ");
                return;
            }

            let isValid = false;
            querySnapshot.forEach((docSnap) => {
                const data = docSnap.data();
                if (data.verificationCode === enteredCode) {
                    isValid = true;

                    // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ŸÇŸÇ
                    updateDoc(doc(db, "users", docSnap.id), { isVerified: true });
                }
            });

            // ‚úÖ ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿ®ÿπÿØ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°
            document.getElementById("overlay").classList.add("hidden");
            msgDiv.classList.remove("opacity-100");
            msgDiv.classList.add("opacity-0");

            if (isValid) {
                // üü¢ ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ŸäŸÖŸäŸÑ ŸÅŸä localStorage ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸÇŸÇ
                localStorage.setItem("verifiedEmail", email);

                // ‚úÖ ÿ•ÿÆŸÅÿßÿ° ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ™ÿ≠ŸÇŸÇ OTP
                document.getElementById("verifying").classList.add("hidden");

                // ‚úÖ ÿ•ÿ∏Ÿáÿßÿ± ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ®ÿ±ŸàŸÅÿßŸäŸÑ
                const profileDiv = document.getElementById("Profile");
                profileDiv.classList.remove("hidden");
                profileDiv.classList.remove("opacity-0");
                profileDiv.classList.add("opacity-100");
            } else {
                alert("‚ùå ÿßŸÑÿ±ŸÖÿ≤ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿå ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ");
            }

        } catch (err) {
            document.getElementById("overlay").classList.add("hidden");
            msgDiv.classList.remove("opacity-100");
            msgDiv.classList.add("opacity-0");

            console.error("ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ™ÿ≠ŸÇŸÇ:", err);
            alert("‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ™ÿ≠ŸÇŸÇ");
        }
    });

});
document.querySelectorAll(".otp-input").forEach((input, index, inputs) => {
    input.addEventListener("input", (e) => {
        if (e.target.value.length > 1) {
            e.target.value = e.target.value.slice(0, 1);
        }
        if (e.target.value && index < inputs.length - 1) {
            inputs[index + 1].focus();
        }
    });

    input.addEventListener("keydown", (e) => {
        if (e.key === "Backspace" && !e.target.value && index > 0) {
            inputs[index - 1].focus();
        }
    });
});

window.addEventListener("load", () => {
    setTimeout(() => {
        ["title", "from", "almggaly"].forEach(id => {
            const el = document.getElementById(id);
            el.classList.replace("opacity-0", "opacity-100");
        });

        const logo = document.getElementById("logo");
        logo.classList.replace("w-20", "w-15");
        logo.classList.remove("md:w-28");
        logo.classList.add("pb-5");

        setTimeout(() => {
            const from = document.getElementById("from");
            const icon = document.getElementById("loadingIcon");
            const almggaly = document.getElementById("almggaly");

            from.classList.add("opacity-0", "opacity-100"); // ŸäÿÆÿ™ŸÅŸä ÿ®ÿ≥ŸÑÿßÿ≥ÿ©
            setTimeout(() => from.classList.add("hidden",), 0); // ŸäÿÆŸÅŸäŸá ŸÜŸáÿßÿ¶Ÿä ÿ®ÿπÿØ ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ

            icon.classList.remove("hidden");
            setTimeout(() => {
                icon.classList.replace("opacity-0", "opacity-100");
            }, 100);

            almggaly.textContent = "Loading...";
            almggaly.classList.add("text-[#0CCC83]");

            setTimeout(() => {
                const header = document.getElementById("header");
                const nextDiv = document.getElementById("sic");

                header.classList.add("opacity-0", "transition-opacity", "duration-700");

                setTimeout(() => {
                    header.classList.add("hidden");
                    nextDiv.classList.remove("hidden");
                    nextDiv.classList.add("opacity-0", "transition-opacity", "duration-700");

                    setTimeout(() => {
                        nextDiv.classList.replace("opacity-0", "opacity-100");
                    }, 50);
                }, 700);
            }, 2000);
        }, 1600);

    }, 1600);
});
document.getElementById("continueBtn").addEventListener("click", function (e) {
    e.preventDefault();

    const sic = document.getElementById("sic");
    const login = document.getElementById("login");

    // ÿßÿÆŸÅÿßÿ° sic ÿ®ÿ≥ŸÑÿßÿ≥ÿ©
    sic.classList.replace("opacity-100", "opacity-0");
    setTimeout(() => {
        sic.classList.add("hidden");

        login.classList.remove("hidden");
        setTimeout(() => {
            login.classList.replace("opacity-0", "opacity-100");
        }, 50);
    }, 700);
});
document.addEventListener("DOMContentLoaded", () => {
    const imageUpload = document.getElementById("imageUpload");
    const profileImage = document.getElementById("profileImage");
    const defaultIcon = document.getElementById("defaultIcon");

    imageUpload.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                profileImage.src = e.target.result;
                profileImage.classList.remove("hidden");
                defaultIcon.classList.add("hidden");
            };
            reader.readAsDataURL(file);
        }
    });
});
// ÿπŸÜÿßÿµÿ± Ÿàÿßÿ¨Ÿáÿ© ÿ®ÿ±ŸàŸÅÿßŸäŸÑ
const profileNextBtn = document.querySelector("#Profile button[type='submit']");
const nameInput = document.querySelector("#Profile input[type='text']");
const imageInput = document.getElementById("imageUpload");
const profileImg = document.getElementById("profileImage");
const defaultIcon = document.getElementById("defaultIcon");

// ÿπŸÜÿØ ÿ±ŸÅÿπ ÿµŸàÿ±ÿ©
imageInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
            profileImg.src = event.target.result;
            profileImg.classList.remove("hidden");
            defaultIcon.classList.add("hidden");
        };
        reader.readAsDataURL(file);
    }
});

// ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ÿ±ŸàŸÅÿßŸäŸÑ
profileNextBtn.addEventListener("click", async (e) => {
    e.preventDefault();

    const fullName = nameInput.value.trim();
    if (!fullName) {
        alert("ŸÖŸÜ ŸÅÿ∂ŸÑŸÉ ÿ£ÿØÿÆŸÑ ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ¥ÿÆÿµŸä");
        return;
    }

    // ÿ•ÿ∞ÿß ŸÅŸäŸá ÿµŸàÿ±ÿ© ŸÖÿ±ŸÅŸàÿπÿ©
    let profileImageUrl = null;
    if (profileImg && !profileImg.classList.contains("hidden")) {
        profileImageUrl = profileImg.src; // ‚ö†Ô∏è ŸäŸÅÿ∂ŸÑ ÿ±ŸÅÿπŸá Firebase Storage
    }

    try {
        // üü¢ ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
        document.getElementById("overlay").classList.remove("hidden");
        const msgDiv = document.getElementById("message");
        msgDiv.classList.remove("opacity-0");
        msgDiv.classList.add("opacity-100");

        // üìå ÿßŸÑÿ•ŸäŸÖŸäŸÑ ÿßŸÑŸÑŸä ÿ™ÿ≠ŸÇŸÇŸÜÿß ŸÖŸÜŸá
        const email = localStorage.getItem("verifiedEmail");
        if (!email) {
            document.getElementById("overlay").classList.add("hidden");
            msgDiv.classList.remove("opacity-100");
            msgDiv.classList.add("opacity-0");

            alert("‚ùå ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿßŸÑŸÖÿ™ÿ≠ŸÇŸÇ ŸÖŸÜŸá");
            return;
        }

        // üîé ŸÜÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ŸÜŸÅÿ≥ ÿßŸÑÿ•ŸäŸÖŸäŸÑ
        const q = query(collection(db, "users"), where("email", "==", email));
        const querySnapshot = await getDocs(q);

        if (!querySnapshot.empty) {
            for (const docSnap of querySnapshot.docs) {
                await updateDoc(doc(db, "users", docSnap.id), {
                    name: fullName,
                    profileImage: profileImageUrl || null,
                });

                // ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿå ŸÜÿ®ŸÜŸä ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑÿ™ÿÆÿ≤ŸäŸÜŸáÿß ŸÖÿ≠ŸÑŸäŸãÿß
                const userData = {
                    id: docSnap.id,
                    email: email,
                    name: fullName,
                    profileImage: profileImageUrl || null,
                };

                // üü¢ ÿ™ÿÆÿ≤ŸäŸÜ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä localStorage
                localStorage.setItem("user", JSON.stringify(userData));
            }

            // ‚úÖ ÿ®ÿπÿØ ÿßŸÑÿ≠ŸÅÿ∏ ŸÜŸÜÿ™ŸÇŸÑ ÿ•ŸÑŸâ ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ©
            window.location.href = "/chat/chat.html";
        } else {
            document.getElementById("overlay").classList.add("hidden");
            msgDiv.classList.remove("opacity-100");
            msgDiv.classList.add("opacity-0");

            alert("‚ùå ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®Ÿáÿ∞ÿß ÿßŸÑÿ®ÿ±ŸäÿØ");
        }
    } catch (err) {
        document.getElementById("overlay").classList.add("hidden");
        const msgDiv = document.getElementById("message");
        msgDiv.classList.remove("opacity-100");
        msgDiv.classList.add("opacity-0");

        console.error("‚ùå ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ÿ±ŸàŸÅÿßŸäŸÑ:", err);
        alert("ÿ≠ÿµŸÑ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ÿ±ŸàŸÅÿßŸäŸÑ üò¢");
    }
});




